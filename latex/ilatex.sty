\ProvidesPackage{ilatex}[2020/04/16 iLaTeX]
\RequirePackage{etoolbox}
\RequirePackage{environ}
\RequirePackage[abspath]{currfile}
\RequirePackage{pdfcomment}
\RequirePackage{graphicx}


% Create an output file named '.ilatex-mappings'
% to write information about certain commands
% (e.g. path of the source file, line number)
% when they are processed the LaTeX engine
\newwrite\Output@ilatex
\immediate\openout\Output@ilatex={\jobname.ilatex-mappings}


% Create a counter to generate identifiers
% that are used to link a piece of code with a PDF annotation
\newcounter{Annotation@ilatex}
\setcounter{Annotation@ilatex}{1}


% Define a command to write a new mapping between
% a line in a source file and an identifier
% in the output file created above
\newcommand{\WriteMapToCurrentLine@ilatex}[1]{%
    \immediate\write\Output@ilatex{type #1}%
    \immediate\write\Output@ilatex{abspath \currfileabspath}%
    \immediate\write\Output@ilatex{line \the\inputlineno}%
    \immediate\write\Output@ilatex{id \theAnnotation@ilatex}%
    \immediate\write\Output@ilatex{---}%
}


% Define a command to declare an interactive annotation
% It expects two arguments:
%   1. the type of content to map;
%   2. the code of the object to annotate.
%
% This command creates a PDF annotation of the same size
% than the element generated by the given code,
% and it writes the mapping between the unique identifier
% used in the annotation and the current location in the code
% in the dedicated output file (see \WriteMapToCurrentLine@ilatex).
\newcommand{\ilatex}[2]{%
    \WriteMapToCurrentLine@ilatex{#1}%
    \pdftooltip{{#2}}{ilatex-code-mapping-id-\theAnnotation@ilatex}%
    \stepcounter{Annotation@ilatex}%
}


% Define a custom includegraphics-like command
% which can be manipulated through ilatex.
\newcommand{\iincludegraphics}[2][]{%
    \ilatex{includegraphics}{\includegraphics[#1]{#2}}%
}


% Define a custom tabular-like environement
% which can be manipulated through ilatex.
\NewEnviron{itabular}[2][c]
{%
    % The \ilatex command seems to fail here,
    % so the PDF annotation is directly performed in here.
    %
    % The current value of the annotation counter is stored as text
    % beforehand to fix an expansion problem which seems to occur
    % when \theAnnotation@ilatex is used directly inside
    % the second argument of \pdftooltip.
    \let\CurrentAnnotationValue@ilatex\theAnnotation@ilatex%
    \pdftooltip{{%
    \begin{tabular}[#1]{#2}%
        \BODY
    \end{tabular}%
    }}{ilatex-code-mapping-id-\CurrentAnnotationValue@ilatex}%
    \stepcounter{Annotation@ilatex}%
}
{}

% Since the environ \NewEnviron command reads the full body
% of the environement before executing env. start code,
% the mapping to the beginning of the environement
% must be written in a different way to get the correct line number.
% Using a hook provided by the etoolbox package seems to work well!
\AtBeginEnvironment{itabular}{%
    \WriteMapToCurrentLine@ilatex{tabular}%
}


\endinput